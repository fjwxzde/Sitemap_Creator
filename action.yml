name: Sitemap Creator Stable
description: GitHub Action ğŸš€ for creating and updating sitemaps in your repository.
author: é¸­é¸­ã€Œã‚«ãƒ¢ã€(@DuckDuckStudio)
color: yellow
icon: book

inputs:
  location:
    required: false
    description: ç½‘ç«™åœ°å›¾çš„å­˜æ”¾ä½ç½® (ä¾‹å¦‚ docs/sitemap.xml)
    default: "./sitemap.xml"

  token:
    required: false
    description: ç”¨äºåˆ›å»ºæ›´æ–°ç½‘ç«™åœ°å›¾çš„æ‹‰å–è¯·æ±‚çš„ Token (ä¸æŒ‡å®šåˆ™ä½¿ç”¨ github.token)
    default: ${{ github.token }}

  timezone:
    required: false
    description: è®¾ç½®ç”Ÿæˆæ—¶ä½¿ç”¨çš„æ—¶åŒº (ä¸æŒ‡å®šåˆ™ä½¿ç”¨ Asia/Shanghai (UTF+8))
    default: "Asia/Shanghai"

  basic_link:
    required: false
    description: æŒ‡å‘ä½ ç½‘ç«™çš„åŸºç¡€é“¾æ¥ (ä¸æŒ‡å®šåˆ™ä½¿ç”¨ GitHub Page é“¾æ¥, ç»“å°¾ä¸è¦å¸¦ / )
    default: https://${{ github.event.repository.owner.login }}.github.io/${{ github.event.repository.name }}

  file_type:
    required: false
    description: ç½‘é¡µæ–‡ä»¶çš„ç±»å‹ (ä¾‹å¦‚ä½¿ç”¨ docsify éƒ¨ç½²çš„å°±æ˜¯ mdï¼Œå¯æŒ‡å®šå¤šä¸ªç±»å‹)
    default: "html,md"

  ignore_file:
    required: false
    description: æŒ‡å®šå“ªäº›æ–‡ä»¶ä¸åŒ…å«åœ¨ç½‘ç«™åœ°å›¾ä¸­
    default: "å•¥éƒ½æ²¡æœ‰" # åº”è¯¥ä¸ä¼šæœ‰äººè¦è¿™ä¸ªï¼Œç•™ç©ºä¼šå¿½ç•¥æ‰€æœ‰æ–‡ä»¶

  website_path:
    required: true
    description: ä½ çš„ç½‘ç«™å†…å®¹çš„ä½ç½® (ä¾‹å¦‚ . (æ ¹ç›®å½•) æˆ– docs)
    default: "./"

  base_branch:
    required: false
    description: ä»“åº“ä¸»åˆ†æ”¯ (mainï¼Œmaster ç­‰)
    default: main

  debug:
    required: false
    description: æ§åˆ¶è°ƒè¯•è¾“å‡ºçš„å¼€å…³
    default: false

  labels:
    required: false
    description: åˆ›å»ºæ‹‰å–è¯·æ±‚æ—¶æ·»åŠ çš„æ ‡ç­¾

  auto_merge:
    required: false
    description: è®¾ç½®å¯ç”¨è‡ªåŠ¨åˆå¹¶çš„ç±»å‹ (ä¸æŒ‡å®šåˆ™ä¸å¯ç”¨è‡ªåŠ¨åˆå¹¶ï¼Œå¯ä»¥ä½¿ç”¨ mergeã€rebaseã€squash)

  update:
    required: false
    description: æŒ‡å®šæ›´æ–°ç½‘ç«™åœ°å›¾çš„æ–¹å¼ (ç›´æ¥æäº¤æˆ–æ‹‰å–è¯·æ±‚)
    default: æ‹‰å–è¯·æ±‚

runs:
  using: composite
  steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # æ£€å‡ºå®Œæ•´è®°å½•

    - name: è®¾ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: "latest"

    - name: è®¾ç½®æ—¶åŒº
      shell: bash
      run: sudo timedatectl set-timezone ${{ inputs.timezone }}

    - name: åˆ›å»º Sitemap
      shell: bash
      env:
        LOCATION: ${{ inputs.location }}
        BASIC_LINK: ${{ inputs.basic_link }}
        FILE_TYPE: ${{ inputs.file_type }}
        IGNORE_FILE: ${{ inputs.ignore_file }}
        WEBSITE_PATH: ${{ inputs.website_path }}
        DEBUG: ${{ inputs.debug }}
      run: |
        # è·å–ç”Ÿæˆè„šæœ¬
        git clone https://github.com/DuckDuckStudio/Sitemap_Creator -b main # ç¨³å®šç‰ˆ
        cp Sitemap_Creator/generate-sitemap.mjs Sitemap_Creator.mjs
        rm -r Sitemap_Creator

        # ç”Ÿæˆç½‘ç«™åœ°å›¾
        node Sitemap_Creator.mjs
        rm Sitemap_Creator.mjs

    - name: æäº¤å¹¶æ¨é€ sitemap.xml
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
        LABELS: ${{ inputs.labels }}
        DEBUG: ${{ inputs.debug }}
        AUTO_MERGE: ${{ inputs.auto_merge }}
        LOCATION: ${{ inputs.location }}
        UPDATE: ${{ inputs.update }}
      run: |
        # åé¢éƒ½è¦ç”¨çš„
        # è·å–å½“å‰æ—¥æœŸå’Œæ—¶é—´
        DATE_TIME=$(date '+%Y/%m/%d %H:%M')

        # å‚æ•°å¤„ç†
        # æ ¼å¼åŒ–æ›´æ–°æ–¹å¼ - é»˜è®¤ PR
        UPDATE_WAY=$(echo "$UPDATE" | tr '[:upper:]' '[:lower:]' | sed "s/[\"\'\`-]//g; s/[[:space:]]//g")
        # æ ¹æ®è¾“å…¥å€¼è®¾ç½®å¯¹åº”çš„æ›´æ–°æ–¹å¼
        case "$UPDATE_WAY" in
          "pr"|"pullrequest"|"pullrequests"|"prs"|"æ‹‰å–è¯·æ±‚")
            UPDATE_WAY="PR"
            if [[ "$DEBUG" ]]; then
              echo "[DEBUG] æ›´æ–°æ–¹å¼: åˆ›å»ºæ‹‰å–è¯·æ±‚"
            fi

            # å¦‚æœ AUTO_MERGE ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œ
            if [[ -z "$AUTO_MERGE" ]]; then
              if [[ "$DEBUG" ]]; then
                echo "[DEBUG] ä¸å¯ç”¨è‡ªåŠ¨åˆå¹¶ï¼Œå› ä¸ºè‡ªåŠ¨åˆå¹¶æ–¹å¼ä¸ºç©º"
              fi
              CLEAN_AUTO_MERGE=""
            else
              # æ ¼å¼åŒ–è‡ªåŠ¨åˆå¹¶æ–¹å¼
              CLEAN_AUTO_MERGE=$(echo "$AUTO_MERGE" | tr '[:upper:]' '[:lower:]' | sed "s/[\"\'\`-]//g")

              # æ ¹æ®è¾“å…¥å€¼è®¾ç½®å¯¹åº”çš„è‡ªåŠ¨åˆå¹¶æ–¹å¼
              case "$CLEAN_AUTO_MERGE" in
                "s"|"squash"|"å‹ç¼©"|"å‹ç¼©åˆå¹¶"|"å‹ç¼©è‡ªåŠ¨åˆå¹¶")
                  CLEAN_AUTO_MERGE="squash"
                  ;;
                "m"|"merge"|"åˆå¹¶"|"åˆå¹¶æäº¤"|"æäº¤")
                  CLEAN_AUTO_MERGE="merge"
                  ;;
                "r"|"rebase"|"å˜åŸº"|"å˜åŸºåˆå¹¶"|"å˜åŸºè‡ªåŠ¨åˆå¹¶")
                  CLEAN_AUTO_MERGE="rebase"
                  ;;
                *)
                  echo "[ERROR] æœªçŸ¥çš„è‡ªåŠ¨åˆå¹¶æ–¹å¼: $AUTO_MERGE"
                  echo "[TIP] å¯ç”¨çš„è‡ªåŠ¨åˆå¹¶æ–¹å¼: å‹ç¼©ã€åˆå¹¶ã€å˜åŸº"
                  exit 1
                  ;;
              esac
            fi

            # å¦‚æœè‡ªåŠ¨åˆå¹¶æ–¹å¼è¿›è¡Œäº†æ ¼å¼åŒ–ï¼Œè¾“å‡ºè°ƒè¯•ä¿¡æ¯
            if [[ ("$AUTO_MERGE" != "$CLEAN_AUTO_MERGE") && ("$DEBUG") ]]; then
              echo "[DEBUG] å·²æ ¼å¼åŒ–è‡ªåŠ¨åˆå¹¶æ–¹å¼: $AUTO_MERGE -> $CLEAN_AUTO_MERGE"
            fi

            # ç§»é™¤æ ‡ç­¾å‚æ•°ä¸­çš„ç‰¹æ®Šå­—ç¬¦
            CLEAN_LABELS=$(echo "$LABELS" | sed "s/[\"\'\`]*//g") # ç§»é™¤ " ' ` å­—ç¬¦
            if [[ ("$LABELS" != "$CLEAN_LABELS") && ("$DEBUG") ]]; then
              echo "[DEBUG] æ ‡ç­¾åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œå·²ç§»é™¤: $LABELS -> $CLEAN_LABELS"
            fi

            # ç­¾å‡ºåˆ†æ”¯
            BRANCH_NAME="sitemap-update-$(date +%Y%m%d%H%M%S)"
            git checkout -b $BRANCH_NAME
            echo "[INFO] å·²åˆ›å»ºæ–°åˆ†æ”¯: $BRANCH_NAME"

            # ç”Ÿæˆå·¥ä½œæµ URL
            WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            ;;
          "commit"|"æäº¤"|"ç›´æ¥æäº¤"|"directcommit"|"commitdirectly")
            UPDATE_WAY="Commit"
            if [[ "$DEBUG" ]]; then
              echo "[DEBUG] æ›´æ–°æ–¹å¼: ç›´æ¥æäº¤åˆ°ä¸»åˆ†æ”¯"
            fi
            # ä¸å¾—åŒæ—¶ä½¿ç”¨çš„å‚æ•°
            params=("LABELS" "AUTO_MERGE")

            # éå†å‚æ•°åç§°æ•°ç»„ï¼Œæ£€æŸ¥å†²çª
            for param_name in "${params[@]}"; do
              param_value="${!param_name}"
              if [[ -n "$param_value" ]]; then
                echo "[ERROR] é”™è¯¯çš„å‚æ•°ä¼ é€’"
                echo "[TIP] $param_name å‚æ•°ä¸å¾—ä¸æ›´æ–°æ–¹å¼â€œæäº¤â€å…±å­˜"
                exit 1
              fi
            done
            ;;
          *)
            echo "[ERROR] æœªçŸ¥çš„æ›´æ–°æ–¹å¼: $AUTO_MERGE"
            echo "[TIP] å¯ç”¨çš„æ›´æ–°æ–¹å¼: æäº¤ã€æ‹‰å–è¯·æ±‚"
            exit 1
            ;;
        esac

        # å‰é¢åšå®Œéƒ½è¦åšçš„

        # é…ç½® Git ç”¨æˆ·
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        # æäº¤å¹¶æ¨é€ sitemap.xml
        git add "$LOCATION"
        git commit -m "[${DATE_TIME}] è‡ªåŠ¨æ›´æ–°ç½‘ç«™åœ°å›¾"
        git config --global push.autoSetupRemote true
        git push

        # æ‹‰å–è¯·æ±‚æ›´æ–°åç»­è¿˜è¦åšçš„
        if [[ "$UPDATE_WAY" == "PR" ]]; then
          # åˆ›å»ºæ‹‰å–è¯·æ±‚
          PR_URL=$(gh pr create --title "[${DATE_TIME}] è‡ªåŠ¨æ›´æ–°ç½‘ç«™åœ°å›¾" \
                                --body "æ­¤æ‹‰å–è¯·æ±‚é€šè¿‡ [å·¥ä½œæµ](${WORKFLOW_URL}) ä½¿ç”¨ [Sitemap Creator](https://github.com/DuckDuckStudio/Sitemap_Creator) åˆ›å»ºã€‚" \
                                --base ${{ inputs.base_branch }} \
                                --head $BRANCH_NAME)
          echo "[INFO] å·²åˆ›å»ºæ‹‰å–è¯·æ±‚: $PR_URL"

          # åˆ¤æ–­æ˜¯å¦æœ‰æ¸…ç†åçš„æ ‡ç­¾å¹¶æ·»åŠ åˆ° PR
          if [[ -n "$CLEAN_LABELS" ]]; then
            gh pr edit "$PR_URL" --add-label "$CLEAN_LABELS"
            echo "[INFO] å·²ä¸ºåˆ›å»ºçš„æ‹‰å–è¯·æ±‚æ·»åŠ æ ‡ç­¾: $CLEAN_LABELS"
          elif [[ "$DEBUG" ]]; then
            echo "[DEBUG] æ²¡æœ‰æœ‰æ•ˆæ ‡ç­¾ï¼Œè·³è¿‡æ·»åŠ æ ‡ç­¾"
          fi

          # åˆ¤æ–­æ˜¯å¦å¯ç”¨è‡ªåŠ¨åˆå¹¶
          # å¦‚æœ CLEAN_AUTO_MERGE æœ‰å€¼ï¼ˆå³è®¾ç½®äº†è‡ªåŠ¨åˆå¹¶æ–¹å¼ï¼‰ï¼Œè¿›è¡Œåç»­å¤„ç†
          if [[ -n "$CLEAN_AUTO_MERGE" ]]; then
            gh pr merge "$PR_URL" --$CLEAN_AUTO_MERGE --auto
            echo "[INFO] å·²ä¸ºæ‹‰å–è¯·æ±‚å¯ç”¨ $CLEAN_AUTO_MERGE åˆå¹¶"
          elif [[ "$DEBUG" ]]; then
            echo "[DEBUG] æ²¡æœ‰æœ‰æ•ˆè‡ªåŠ¨åˆå¹¶æ–¹å¼ï¼Œè·³è¿‡å¯ç”¨è‡ªåŠ¨åˆå¹¶"
          fi
        fi
